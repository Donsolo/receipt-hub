generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String    @id @default(cuid())
  email           String    @unique
  password        String
  role            String    @default("USER")
  createdAt       DateTime  @default(now())
  lastSeenChangelogVersion String?
  isActivated         Boolean   @default(true)
  isEarlyAccess       Boolean   @default(false)
  activatedAt         DateTime?
  activationSource    String?
  activationTransactionId String?
  businessAddress String?
  businessName    String?
  businessPhone   String?
  name            String?
  receipts        Receipt[]
  
  // Connections
  sentConnections     Connection[] @relation("Requester")
  receivedConnections Connection[] @relation("Receiver")

  // Messages
  sentMessages        Message[]    @relation("Sender")
  receivedMessages    Message[]    @relation("MessageReceiver")

  // Saved Receipt Items for Auto-Populate
  savedReceiptItems   SavedReceiptItem[]
  
  // Feedback System
  feedbacks           Feedback[]
}

model Receipt {
  id            String        @id @default(cuid())
  receiptNumber String?       @unique
  userId        String
  imageUrl      String?
  date          DateTime
  clientName    String?
  notes         String?
  taxType       String        @default("none")
  taxValue      Float?
  subtotal      Float         @default(0)
  total         Float         @default(0)
  createdAt     DateTime      @default(now())
  fileSize      Int?
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  items         ReceiptItem[]
  messages      MessageReceipt[]
}

model ReceiptItem {
  id          String  @id @default(cuid())
  receiptId   String
  description String
  quantity    Int
  unitPrice   Float
  lineTotal   Float
  receipt     Receipt @relation(fields: [receiptId], references: [id], onDelete: Cascade)
}

model BusinessProfile {
  id              String  @id @default(cuid())
  businessName    String
  businessAddress String?
  businessPhone   String?
  businessEmail   String?
  logoPath        String?
}

model Connection {
  id          String   @id @default(cuid())
  requesterId String
  receiverId  String
  status      String   @default("pending") // "pending", "accepted", "declined"
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  requester   User     @relation("Requester", fields: [requesterId], references: [id], onDelete: Cascade)
  receiver    User     @relation("Receiver", fields: [receiverId], references: [id], onDelete: Cascade)

  @@unique([requesterId, receiverId])
}

model Message {
  id         String   @id @default(cuid())
  senderId   String
  receiverId String
  text       String
  createdAt  DateTime @default(now())

  sender     User     @relation("Sender", fields: [senderId], references: [id], onDelete: Cascade)
  receiver   User     @relation("MessageReceiver", fields: [receiverId], references: [id], onDelete: Cascade)
  receipts   MessageReceipt[]
}

model MessageReceipt {
  id        String   @id @default(cuid())
  messageId String
  receiptId String
  createdAt DateTime @default(now())

  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  receipt   Receipt  @relation(fields: [receiptId], references: [id], onDelete: Cascade)

  @@unique([messageId, receiptId])
}

model SavedReceiptItem {
  id             String   @id @default(cuid())
  userId         String
  name           String
  normalizedName String
  usageCount     Int      @default(1)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, normalizedName])
  @@index([userId, normalizedName])
}

model SystemSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Feedback {
  id            String   @id @default(cuid())
  userId        String
  type          String   // 'positive', 'suggestion', 'bug'
  message       String
  rating        Int?     // 1-5
  isApproved    Boolean  @default(false)
  isShowcased   Boolean  @default(false)
  createdAt     DateTime @default(now())

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([type])
  @@index([isShowcased])
}
